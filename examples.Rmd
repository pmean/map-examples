---
title: "map-examples"
author: "Steve Simon"
date: "December 29, 2016"
output: html_document
---

```{r setup}
library("dplyr")
library("ggmap")
library("lubridate")
library("magrittr")
library("tidyr")
library("tibble")

r <- 6371
p <- 2*pi*r / 360
a <- cos(39*pi/180)
```

Latitude starts at 0 at the equator, goes up to 180 degrees at the North Pole, and down to -180 degrees at the South Pole. Longitude stats at 0 at the Greenwich Meridian, goes up to 180 as you head west and down to -180 as you head east. The radius of the earth is roughly `r r`. Multiply this by 2 pi and divide by 360 to get `r round(p, 1)` kilometers per degree of latitude. Longitude is a bit trickier. At the equator, a degree of longitude is the same as a degree of latitude. But things shrink as you move towards the poles. You have to adjust for this, and the adjustment factor equals the cosine of the latitude. So, for example, Kansas City is roughly at 39 degrees of latitude, so the adjustment factor is `r round(a, 3)`, making a degree of longitude only `r round(p*a, 1)` kilometers.

This is a reasonable approximation, but you can adjust for the fact that the earth is not a perfect sphere (it is slightly flatter at the poles than at the equator). You can also adjust for the curvature of the earth if the distances are far enough apart. 

One last thing: I usually get this wrong, but when you draw a plot, longitude goes on the x-axis and latitude goes on the y-axis.

The file Track 502.gpx should be available at my github site.

The "interesting" lines in this file look something like

"<trkpt lat=38.8788925 lon=-94.6658353>" 

or

"<ele>295.312</ele>"                    

or

"<time>2017-01-01T16:02:04.212Z</time>"

```{r gpx}
"Track 502.gpx" %>% read.delim(header=FALSE, as.is=TRUE, sep="~") -> gpx_lines

gpx <- NULL
gpx_lines$V1 %>%
  grep("<time>", ., value=TRUE) %>%
  sub(".+T", "", .) %>%
  sub("Z</time>", "", .) %>%
  as.numeric  %>%
  as_tibble %>%
  bind_cols(gpx) %>%
  rename(timd=value) -> gpx

gpx_lines$V1 %>%
  grep("trkpt lat=", ., value=TRUE) %>%
  sub("<trkpt lat=", "", .) %>%
  sub(" lon=.+", "", .) %>%
  as.numeric  %>%
  as_tibble %>%
  bind_cols(gpx) %>%
  rename(lat=value) -> gpx

gpx_lines$V1 %>%
  grep("trkpt lat=", ., value=TRUE) %>%
  sub(".+ lon=", "", .) %>%
  sub(">", "", .) %>%
  as.numeric  %>%
  as_tibble %>%
  bind_cols(gpx) %>%
  rename(lon=value) -> gpx
head(gpx)

qmplot(lon, lat, data=gpx)
```

Please download the 311 center center service requests file from 

https://data.kcmo.org/browse?category=311

```{r propery_violations}
fn <- "311_Call_Center_Service_Requests.csv"
cc <- read.csv(file=fn, header=TRUE, as.is=TRUE)
names(cc) %<>% tolower
str(cc)
cc_sub <- cc[1:100,]
qmplot(longitude, latitude, data=cc_sub)
```